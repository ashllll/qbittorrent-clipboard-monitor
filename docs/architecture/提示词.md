# AI分类提示词优化报告

## 1. 优化后的AI提示词

基于对项目分析报告（AajD6）及优化建议（Admq9）的深入分析，特别是AI分类逻辑和提示词工程部分，我们构建了以下优化后的AI提示词。该提示词旨在提高分类的准确性、一致性及对复杂或边缘案例的处理能力。

System Message (系统消息):
```text
你是一个专业的种子分类助手。你的任务是根据用户提供的种子信息，严格遵循给定的分类规则和可用分类列表，将其分类到最合适的类别中。必须且只能返回一个分类名称，不要包含任何其他文字、解释、标点或符号。如果无法确定，请返回 'other'。
```

Optimized User Prompt Template (优化后的用户提示词模板):
```python
"""请根据以下信息，将种子分类到最合适的类别中。

---
任务目标: 根据种子信息，从提供的列表中选择一个最匹配的分类。

---
可用分类列表及其详细描述:
{category_descriptions_with_keywords}

---
待分类种子信息:
种子名称: {torrent_name}
种子哈希: {torrent_hash} # 添加哈希信息，虽然不直接用于分类，但提供了唯一标识符，有时文件名模糊时AI可能需要参考其上下文（尽管DeepSeek可能无法直接用哈希）
文件列表: {file_list} # 添加文件列表信息 (来自元数据利用增强建议)
总大小: {total_size} # 添加总大小信息 (来自元数据利用增强建议)

---
分类规则与考量 (AI应优先参考这里的规则和可用分类列表):
1.  核心判断: 主要依据“种子名称”、“文件列表”和“总大小”判断内容类型。
2.  特征识别:
    *   电视剧: 通常包含SXXEXX格式的季/集信息，或"Season"、"Episode"、"剧集"等词。文件列表中可能包含多个视频文件。
    *   电影: 通常包含年份(如2020)、分辨率(1080p, 4K, 2160p)、编码(H.264, HEVC)、来源标签(BluRay, WEB-DL, BDRip)。文件列表中通常包含单个或少数视频文件。
    *   成人内容: 通常包含明显的成人关键词、成人制作商名称、或特定的文件命名模式。
    *   日本动画 (Anime): 通常包含"动画"、"动漫"、"[机构/字幕组]"、"UNCENSORED"、"无修"等术语。
    *   音乐 (Music): 通常包含专辑/艺术家名称、格式(FLAC, MP3)、"Album"等词。文件列表中通常包含音频文件和封面图片。
    *   游戏 (Games): 通常包含游戏名称、平台(PC, Switch)、"Reloaded", "CODEX"等破解组名称。文件列表中可能包含安装文件、可执行文件。
    *   软件 (Software): 通常包含软件名称、版本号、操作系统(Windows, macOS)。文件列表中可能包含安装包、注册机。
3.  优先级: 如果种子信息同时符合多个分类的描述和规则，选择最具体的或最符合核心内容的分类。
4.  不确定处理: 如果种子信息非常模糊，或不明显属于任何明确分类，返回 'other'。
5.  输出格式: 严格遵循系统消息的输出要求，只返回分类名称，例如：`movies` 或 `tv`。

---
少量示例 (Few-Shot Examples) - 供参考和学习输出格式: # 添加Few-shot示例支持
Input:
种子名称: [SubsPlease] Dungeon Meshi - 14 (1080p) [F65594EE].mkv
文件列表: ["Dungeon Meshi - 14.mkv"]
总大小: 350MB
Output: anime

Input:
种子名称: The.Lord.of.the.Rings.The.Fellowship.of.the.Ring.2001.EXTENDED.UHD.BluRay.2160p.TrueHD.Atmos.7.1.HEVC.REMUX-FraMeSToR
文件列表: ["The Lord of the Rings The Fellowship of the Ring 2001 EXTENDED UHD BluRay 2160p TrueHD Atmos 7.1 HEVC REMUX-FraMeSToR.mkv"]
总大小: 98GB
Output: movies

Input:
种子名称: Succession S04E09 1080p WEB-DL DD+5.1 H.264-NTb
文件列表: ["Succession.S04E09.1080p.WEB-DL.DD+5.1.H.264-NTb.mkv"]
总大小: 2GB
Output: tv

Input:
种子名称: 1577505565
文件列表: []
总大小: 0MB
Output: other

Input:
种子名称: VA - Billboard Hot 100 [2024-07-20] [WEB] [24bit] [FLAC]
文件列表: ["01. Artist Name - Song Title.flac", "02. Artist Name - Song Title.flac", "cover.jpg"]
总大小: 1.5GB
Output: music

Input:
种子名称: Adobe Photoshop 2024 v25.9.1 RePack by KpoJIuK
文件列表: ["Setup.exe", "Crack.dll", "Instructions.txt"]
总大小: 4GB
Output: software

Input:
种子名称: Elden Ring
文件列表: ["eldenring.exe", "steam_api64.dll", "..."]
总大小: 50GB
Output: games

Input:
种子名称: User provided category not in list or is ambiguous
文件列表: []
总大小: 0MB
Output: other

---
请根据以上信息，判断最合适的分类，并只输出分类名称。
"""
```

*注: `{category_descriptions_with_keywords}` 是一个新的占位符，用于更结构化地整合 `category_descriptions` 和 `category_keywords` 信息，例如可以格式化为每个分类一行，包含名称、描述和关键词列表。`{file_list}` 和 `{total_size}` 是来自元数据利用增强建议的新的输入信息占位符，如果这些信息不可用，应传入空列表 `[]` 和 `0MB` 或类似的表示方式。*

## 2. 原始提示词与优化后提示词的对比分析

| 特征                 | 原始提示词 (User Prompt + System Message)                                  | 优化后提示词                                                                                                | 对比分析                                                                                                                               |
| :------------------- | :--------------------------------------------------------------------------- | :---------------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------- |
| 系统消息         | 简单说明角色和输出格式。                                                       | 强化角色、任务目标、严格输出格式要求及不确定时的处理方式 ('other')。                                                    | 提高了对模型行为的约束力，减少输出无关内容的概率。                                                                                                |
| 用户提示词结构   | 包含种子名称、可用分类描述、关键词提示、分类要求。结构相对扁平。                                    | 结构更清晰，分块明确：任务目标、可用分类、待分类信息、规则与考量、少量示例、最终指令。增加了分隔符。                             | 提高提示词的可读性和逻辑性，有助于模型更好地理解不同部分的作用。                                                                                              |
| 输入信息         | 仅 `种子名称: {torrent_name}`                                                | `种子名称: {torrent_name}`<br>`种子哈希: {torrent_hash}`<br>`文件列表: {file_list}`<br>`总大小: {total_size}` | 重大增强: 集成了更多元数据，为AI提供更丰富的上下文信息，有助于区分文件名相似但内容不同的种子 (如电影 vs 剧集，软件 vs 游戏)。                               |
| 分类规则与考量   | 列出7条规则，包含常见分类特征和不确定处理。                                            | 列出5条规则，更强调“核心判断”、“特征识别”（更详细），并包含优先级和不确定处理。位置更显眼。                                      | 规则更结构化，更紧密地结合了不同数据源 (名称, 文件列表, 大小)，指导AI如何综合信息。                                                              |
| 少数示例 (Few-shot)| 无                                                                       | 新增 少量示例部分，包含多种分类的 Input/Output 对。                                                    | 重大增强: 通过具体示例直接教会模型输入格式、预期输出格式以及如何根据输入特征进行分类判断。对于复杂或边缘案例，示例的指导作用远大于纯文本规则。                         |
| 分类描述/关键词  | 分开列出“可用分类及其描述”和“关键词提示”。                                             | 合并并统一格式化为“可用分类列表及其详细描述”。                                                                  | 将分类描述和关键词结合，更方便AI理解每个分类的完整定义。新的占位符 `{category_descriptions_with_keywords}` 提示后端需要整合这些信息。                           |
| 输出格式指令     | 位于提示词末尾，强调“只返回最合适的分类名称... 不要包含任何其他解释或文字。”                                 | 系统消息和用户提示词末尾都强调输出格式，少量示例也直观展示了格式。                                                        | 多处重复强调输出格式，并通过 Few-shot 示例进行演示，进一步降低模型输出无关内容的可能性。                                                                 |
| 鲁棒性考量       | 未直接体现在提示词中，仅在代码中有失败退回规则引擎的逻辑。                                        | 提示词明确了不确定时返回 'other'，这有助于模型在无法判断时提供一个有效的回退值，而不是随意猜测或输出格式错误。                       | 提升了AI分类本身的鲁棒性，为后端退回规则引擎提供了更可靠的信号 (当AI返回 'other' 时)。                                                              |

## 3. 优化理由详细解释

进行上述优化的主要理由如下：

1.  引入 Few-shot Examples (少量示例):
    *   理由: 这是提高大型语言模型在特定任务上性能最有效的方法之一。纯粹的文本指令有时难以涵盖所有复杂情况或微妙之处。通过提供少量精心挑选的示例，我们可以直观地展示期望的输入格式、输出格式，以及在不同输入特征组合下（例如，电影 vs 电视剧的命名模式差异、是否包含文件列表）应如何进行分类判断。AI可以直接从这些示例中学习模式。
    *   提高准确性/鲁棒性: Few-shot 可以显著提高模型对指令的遵循能力（特别是输出格式），并帮助模型处理那些用纯文本规则难以描述的边缘案例或不常见的命名模式。它减少了模型的“幻觉”或基于一般互联网知识进行的错误猜测，使其更聚焦于任务定义和提供的示例。

2.  集成更多元数据 (文件列表, 总大小):
    *   理由: 种子名称虽然是主要的识别信息，但很多时候可能模糊、不完整或具有误导性。文件列表（包含文件名、扩展名）和总大小是种子内容的客观反映。例如，一个名为 "Movie" 的种子，如果文件列表中包含多个 `.mkv` 文件且总大小几十GB，很可能是剧集合集而不是单部电影；一个包含 `.exe` 和 `.dll` 文件的种子更可能是软件或游戏安装包。利用这些信息能大大提高分类的准确性，尤其是在种子名称不足够清晰时。
    *   提高准确性/鲁棒性: 提供了额外的、更可靠的证据供AI参考。这有助于AI区分命名相似的不同内容类型，减少误分类。例如，一个包含 "XXX" 的名称，如果文件列表显示是图片或文档，可能不是成人内容；如果文件列表显示是大量音频文件，则可能是音乐专辑。

3.  强化系统消息和输出格式约束:
    *   理由: 虽然原始提示词已经提到了输出格式，但在实际使用中，LLM 有时会“健谈”，添加解释性文字或不按要求格式输出。将严格的输出格式要求放在系统消息中并配合 Few-shot 示例演示，可以最大限度地减少这种不期望的行为。
    *   提高准确性/一致性: 确保AI的输出可以直接被程序解析和使用，减少后处理的复杂性和出错率。返回 'other' 的明确指令为不确定情况提供了一个标准化的回退路径。

4.  优化提示词结构和分类规则描述:
    *   理由: 清晰的结构有助于AI更好地解析提示词的不同组成部分。将分类规则与不同数据源 (名称、文件列表、大小) 更紧密地结合，并强调判断逻辑，能指导AI如何综合利用所有可用信息进行决策。
    *   提高准确性: 有助于AI理解不同信息源之间的关系和判断优先级，使其决策过程更符合预期。

## 4. 具体修改内容

以下是相较于原始提示词模板和系统消息的具体修改内容：

1.  修改 System Message:
    *   原始: `"你是一个专业的种子分类助手，擅长根据文件名进行准确分类。请只返回最合适的分类名称，不要包含任何其他解释或文字。"`
    *   优化: `"你是一个专业的种子分类助手。你的任务是根据用户提供的种子信息，严格遵循给定的分类规则和可用分类列表，将其分类到最合适的类别中。必须且只能返回一个分类名称，不要包含任何其他文字、解释、标点或符号。如果无法确定，请返回 'other'。"`
    *   修改点:
        *   增加了“严格遵循给定的分类规则和可用分类列表”的要求。
        *   将输出格式要求从“请只返回...”加强为“必须且只能返回一个分类名称，不要包含任何其他文字、解释、标点或符号。”
        *   明确了不确定时返回 'other'。

2.  修改 User Prompt Template:
    *   新增结构化分隔符: 使用 `---` 将提示词内容划分为不同逻辑块 (任务目标, 可用分类, 待分类信息, 规则与考量, 少量示例, 最终指令)。
    *   新增“任务目标”块: 开头明确任务目标，提高聚焦性。
    *   修改“可用分类”块:
        *   将原始的 `可用分类及其描述: {category_descriptions}` 和 `关键词提示: {category_keywords}` 合并为一个新的逻辑块，使用新的占位符 `{category_descriptions_with_keywords}`，并建议更结构化的格式。
    *   新增“待分类种子信息”块:
        *   添加新的输入字段及占位符：`种子哈希: {torrent_hash}`、`文件列表: {file_list}`、`总大小: {total_size}`。
    *   修改“分类规则与考量”块:
        *   将原始的7条规则精简并整合为5条，但内容更详细，特别是“特征识别”部分，明确提及了“文件列表”和“总大小”作为判断依据。
        *   强调“AI应优先参考这里的规则和可用分类列表”。
        *   新增“优先级”规则。
        *   调整了条目编号和措辞。
    *   新增“少量示例 (Few-Shot Examples)”块:
        *   新增此块，包含多个 `Input: ... Output: ...` 示例对，覆盖了多种常见分类和不确定情况。这是最重要的结构性修改。
    *   修改最终指令:
        *   原始提示词末尾的输出格式要求被系统消息和 Few-shot 示例替代。
        *   新增一个简单的最终指令：“请根据以上信息，判断最合适的分类，并只输出分类名称。”，作为对AI行动的最后触发。

## 5. 优化后提示词的预期效果和具体好处

优化后的AI提示词预计将带来以下效果和好处：

1.  提高分类准确性:
    *    Few-shot示例: 使AI更好地理解和学习如何根据种子名称和元数据组合进行分类，减少对不常见命名模式的误判。
    *   更多元数据: 文件列表和总大小提供了文件名本身缺乏的客观信息，尤其在名称模糊或有歧义时（例如，区分电影和剧集合集，区分软件和游戏等），能够显著提高判断的准确性。
    *   优化规则描述: 更结构化和详细的规则，特别是结合了多源信息的规则，有助于AI做出更合理的判断。

2.  提高分类一致性:
    *   Few-shot示例: 通过展示期望的分类结果，引导AI在相似输入下给出一致的分类判断，减少随机性。
    *   强化输出格式约束: 系统消息和示例共同作用，确保AI的输出格式高度一致，方便后续处理。

3.  更好地处理不同类型的种子名称和边缘案例:
    *   Few-shot示例和详细规则: 专门设计 Few-shot 示例和规则来覆盖常见分类特征和潜在的边缘情况，如名称模糊、包含多种内容迹象的种子等。
    *   不确定时的 'other' 回退: AI在无法自信判断时会返回 'other'，这使得规则引擎的退退更可靠，不会因为AI的错误猜测而导致后续处理错误。

4.  减少模型幻觉或错误分类:
    *   聚焦任务: 清晰的结构、任务目标和严格的输出约束，使AI更专注于分类任务本身，减少生成无关内容或基于错误假设进行判断的可能性。
    *   更多证据: 文件列表和总大小提供了具体、客观的证据，约束了AI的想象空间，使其判断更基于实际内容而非仅凭名称联想。

5.  提升整体AI分类模块的鲁棒性:
    *   虽然提示词本身不处理API调用层面的健壮性（如重试、超时），但提示词层面的优化使得AI分类本身更可靠。结合后端已有的或计划中的API调用健壮性增强（如Admq9建议的指数退避重试），整个AI分类流程将更加稳定和高效。

为了充分发挥优化后提示词的效果，需要在代码中实现以下支持：
*   修改 `AIClassifier._build_prompt` 或相关逻辑，以适配新的提示词模板结构，并填充所有占位符 (`{torrent_name}`, `{torrent_hash}`, `{category_descriptions_with_keywords}`, `{file_list}`, `{total_size}`).
*   实现获取种子文件列表和总大小的逻辑（参考AajD6的元数据利用增强建议），并在调用AI分类器之前准备好这些数据。
*   在 `config.json` 中支持配置 Few-shot 示例列表，并由 `AIClassifier` 读取和格式化到提示词中。
*   调整 `category_descriptions` 和 `category_keywords` 在配置中的结构，或在代码中逻辑地将它们整合成 `{category_descriptions_with_keywords}` 占位符所需的内容。